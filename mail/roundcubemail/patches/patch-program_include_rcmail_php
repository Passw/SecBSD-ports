From d2e8a889c4094b5890a7d1e162aa9b6044b8baad Mon Sep 17 00:00:00 2001
From: Aleksander Machniak <alec@alec.pl>
Date: Sun, 9 Jul 2023 11:23:44 +0200
Subject: [PATCH] Fix regression that broke use_secure_urls feature (#9052)

From ca1b23ea9d8ddbfeaf973158f508a5f70ae51db8 Mon Sep 17 00:00:00 2001
From: Aleksander Machniak <alec@alec.pl>
Date: Mon, 10 Jul 2023 18:27:56 +0200
Subject: [PATCH] More fixes regarding rcmail::url() (#9052)

Index: program/include/rcmail.php
--- program/include/rcmail.php.orig
+++ program/include/rcmail.php
@@ -1169,7 +1169,7 @@ class rcmail extends rcube
             $path = $_SERVER[$path];
         }
         else if (empty($path)) {
-            foreach (['REDIRECT_SCRIPT_URL', 'SCRIPT_NAME', 'REQUEST_URI'] as $name) {
+            foreach (['REQUEST_URI', 'REDIRECT_SCRIPT_URL', 'SCRIPT_NAME'] as $name) {
                 if (!empty($_SERVER[$name])) {
                     $path = $_SERVER[$name];
                     break;
@@ -1180,7 +1180,8 @@ class rcmail extends rcube
             return rtrim($path, '/') . '/';
         }
 
-        $path = preg_replace('/[?&].*$/', '', (string) $path);
+        $path = preg_replace('/index\.php.*$/', '', (string) $path);
+        $path = preg_replace('/[?&].*$/', '', $path);
         $path = preg_replace('![^/]+$!', '', $path);
 
         return rtrim($path, '/') . '/';
