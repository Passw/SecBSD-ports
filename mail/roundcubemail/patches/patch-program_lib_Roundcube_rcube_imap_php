From 813dacec712b98e43f25fbac9b7a78c68ba7f0c6 Mon Sep 17 00:00:00 2001
From: Aleksander Machniak <alec@alec.pl>
Date: Sun, 9 Jul 2023 13:18:11 +0200
Subject: [PATCH] Fix potential PHP fatal error when opening a message with
 message/rfc822 part (#8953)

From e5c5676fcc52079d43053baa1641e7fa405b0153 Mon Sep 17 00:00:00 2001
From: Adrien Beau <abe.github@zerty.xyz>
Date: Sun, 9 Jul 2023 19:51:10 +0200
Subject: [PATCH] Fix sort_folder_comparator (#9057)

Index: program/lib/Roundcube/rcube_imap.php
--- program/lib/Roundcube/rcube_imap.php.orig
+++ program/lib/Roundcube/rcube_imap.php
@@ -2060,15 +2060,17 @@ class rcube_imap extends rcube_storage
 
             // find first non-array entry
             for ($i=1; $i<count($part); $i++) {
-                if (!is_array($part[$i])) {
+                if (is_string($part[$i])) {
                     $struct->ctype_secondary = strtolower($part[$i]);
 
                     // read content type parameters
                     if (isset($part[$i+1]) && is_array($part[$i+1])) {
                         $struct->ctype_parameters = [];
                         for ($j=0; $j<count($part[$i+1]); $j+=2) {
-                            $param = strtolower($part[$i+1][$j]);
-                            $struct->ctype_parameters[$param] = $part[$i+1][$j+1];
+                            if (is_string($part[$i+1][$j])) {
+                                $param = strtolower($part[$i+1][$j]);
+                                $struct->ctype_parameters[$param] = $part[$i+1][$j+1];
+                            }
                         }
                     }
 
@@ -2146,7 +2148,9 @@ class rcube_imap extends rcube_storage
         if (is_array($part[$params_idx])) {
             $struct->ctype_parameters = [];
             for ($i=0; $i<count($part[$params_idx]); $i+=2) {
-                $struct->ctype_parameters[strtolower($part[$params_idx][$i])] = $part[$params_idx][$i+1];
+                if (is_string($part[$params_idx][$i])) {
+                    $struct->ctype_parameters[strtolower($part[$params_idx][$i])] = $part[$params_idx][$i+1];
+                }
             }
 
             if (isset($struct->ctype_parameters['charset'])) {
@@ -2187,7 +2191,9 @@ class rcube_imap extends rcube_storage
             }
             if (is_array($part[$di][1])) {
                 for ($n=0; $n<count($part[$di][1]); $n+=2) {
-                    $struct->d_parameters[strtolower($part[$di][1][$n])] = $part[$di][1][$n+1];
+                    if (is_string($part[$di][1][$n])) {
+                        $struct->d_parameters[strtolower($part[$di][1][$n])] = $part[$di][1][$n+1];
+                    }
                 }
             }
         }
@@ -4515,7 +4521,10 @@ class rcube_imap extends rcube_storage
         $path1 = explode($this->delimiter, $str1);
         $path2 = explode($this->delimiter, $str2);
 
-        foreach ($path1 as $idx => $folder1) {
+        $len = max(count($path1), count($path2));
+
+	for ($idx = 0; $idx < $len; $idx++) {
+            $folder1 = $path1[$idx] ?? '';
             $folder2 = $path2[$idx] ?? '';
 
             if ($folder1 === $folder2) {
